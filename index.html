<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord des Catastrophes Naturelles</title>
    <!-- Inclure Tailwind CSS pour un style moderne et responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclure Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh; /* Utilise min-h-screen de Tailwind pour une hauteur minimale de 100% de la vue */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* Coins plus arrondis */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Ombre plus prononcée */
            padding: 3rem; /* Plus de padding */
            width: 100%;
            max-width: 1200px; /* Largeur maximale augmentée pour plus d'espace */
            margin-top: 20px;
        }
        .section-card {
            background-color: #ffffff; /* Fond blanc pour les cartes de section */
            border-radius: 0.75rem; /* Coins arrondis */
            padding: 2rem; /* Plus de padding */
            margin-top: 2rem; /* Plus d'espace entre les sections */
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Ombre subtile */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Transition pour le survol */
        }
        .section-card:hover {
            transform: translateY(-5px); /* Léger mouvement vers le haut au survol */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Ombre plus forte au survol */
        }
        .alert-item {
            background-color: #fef2f2; /* Rouge très clair */
            border-left: 5px solid #ef4444; /* Bordure rouge plus épaisse */
            padding: 1.25rem; /* Plus de padding */
            margin-bottom: 0.75rem; /* Plus d'espace entre les alertes */
            border-radius: 0.5rem; /* Coins arrondis */
            font-size: 1rem; /* Taille de police légèrement plus grande */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Ombre subtile */
        }
        .alert-item strong {
            color: #dc2626; /* Rouge plus foncé */
            font-weight: 700; /* Plus gras */
        }
        /* Style pour les cartes de prévisions journalières */
        .daily-forecast-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .daily-forecast-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <!-- Titre de la page -->
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-8">
            Tableau de Bord des Catastrophes Naturelles
        </h1>

        <!-- Barre de navigation -->
        <nav class="flex flex-wrap justify-center gap-6 mb-10 p-3 bg-gradient-to-r from-blue-600 to-blue-800 rounded-full shadow-xl">
            <a href="index.html" class="px-6 py-3 bg-blue-700 text-white font-bold rounded-full shadow-md hover:bg-blue-900 transition ease-in-out duration-300 transform hover:scale-105">
                Accueil
            </a>
            <a href="earthquake_map.html" class="px-6 py-3 text-white font-semibold rounded-full hover:bg-blue-700 transition ease-in-out duration-300 transform hover:scale-105">
                Carte des Séismes
            </a>
            <a href="country_info.html" class="px-6 py-3 text-white font-semibold rounded-full hover:bg-blue-700 transition ease-in-out duration-300 transform hover:scale-105">
                Informations sur les Pays
            </a>
        </nav>

        <!-- Section: Catastrophes Météorologiques à Proximité (GPS) -->
        <div class="section-card">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Catastrophes Météorologiques à Proximité (GPS)</h2>
            <div class="flex flex-col sm:flex-row items-center gap-6 mb-6">
                <button id="getLocationButton" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition ease-in-out duration-300 transform hover:scale-105">
                    Obtenir ma position et les alertes
                </button>
                <div id="locationInfo" class="text-gray-700 text-lg font-medium"></div>
            </div>
            <div id="weatherAlerts" class="mt-6">
                <p class="text-gray-600 text-base">Cliquez sur le bouton pour obtenir les alertes météorologiques pour votre position actuelle.</p>
            </div>
        </div>

        <!-- Section: Prévisions Météorologiques et Graphiques -->
        <div class="section-card">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Prévisions Météorologiques (Prochaines 48h)</h2>
            <div id="forecastLocationName" class="text-gray-700 font-semibold text-lg mb-4"></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Température Horaire</h3>
                    <canvas id="tempChart" class="w-full h-auto"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Probabilité de Précipitation (5 jours)</h3>
                    <canvas id="popChart" class="w-full h-auto"></canvas>
                </div>
            </div>
            <div id="dailyForecastSummary" class="mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Résumé des prévisions journalières:</h3>
                <div id="dailyForecastContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Les prévisions journalières seront insérées ici -->
                </div>
            </div>
        </div>

        <!-- Message de chargement global -->
        <div id="loading-message" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 text-white text-3xl font-bold rounded-lg hidden">
            Chargement des données...
        </div>

        <!-- Message d'erreur/information -->
        <div id="status-message" class="fixed bottom-6 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl z-50 text-xl font-semibold hidden">
            <!-- Les messages d'erreur ou d'information seront affichés ici -->
        </div>
    </div>

    <script>
        // REMPLACEZ 'VOTRE_CLE_API_OPENWEATHER' par votre clé API OpenWeatherMap
        const OPENWEATHER_API_KEY = "VOTRE_CLE_API_OPENWEATHER";

        let tempChartInstance = null; // Pour stocker l'instance du graphique Chart.js pour la température
        let popChartInstance = null; // Pour stocker l'instance du graphique Chart.js pour la POP

        // Fonction pour afficher des messages temporaires à l'utilisateur
        function showStatusMessage(message, isError = false) {
            const statusMessageDiv = document.getElementById('status-message');
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `fixed bottom-6 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl z-50 text-xl font-semibold ${isError ? 'bg-red-600' : 'bg-blue-600'} text-white`;
            statusMessageDiv.classList.remove('hidden');
            setTimeout(() => {
                statusMessageDiv.classList.add('hidden');
            }, 5000); // Masquer après 5 secondes
        }

        // Fonction pour afficher/masquer le message de chargement global
        function toggleLoading(show) {
            document.getElementById('loading-message').classList.toggle('hidden', !show);
        }

        // Fonction pour obtenir la position GPS de l'utilisateur
        document.getElementById('getLocationButton').addEventListener('click', () => {
            toggleLoading(true);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('locationInfo').textContent = `Votre position: Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`;
                    fetchWeatherAndAlerts(lat, lon);
                }, error => {
                    toggleLoading(false);
                    let errorMessage = "Impossible d'obtenir votre position.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += " Veuillez autoriser l'accès à la localisation dans les paramètres de votre navigateur.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += " Informations de localisation non disponibles.";
                            break;
                        case error.TIMEOUT:
                            errorMessage += " La demande de localisation a expiré.";
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMessage += " Une erreur inconnue est survenue.";
                            break;
                    }
                    showStatusMessage(errorMessage, true);
                    document.getElementById('weatherAlerts').innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                });
            } else {
                toggleLoading(false);
                showStatusMessage("La géolocalisation n'est pas supportée par votre navigateur.", true);
                document.getElementById('weatherAlerts').innerHTML = `<p class="text-red-500">La géolocalisation n'est pas supportée par votre navigateur.</p>`;
            }
        });

        // Fonction pour récupérer les données météorologiques et les alertes
        async function fetchWeatherAndAlerts(lat, lon) {
            if (OPENWEATHER_API_KEY === "VOTRE_CLE_API_OPENWEATHER") {
                toggleLoading(false);
                showStatusMessage("Veuillez remplacer 'VOTRE_CLE_API_OPENWEATHER' par votre clé API OpenWeatherMap.", true);
                document.getElementById('weatherAlerts').innerHTML = `<p class="text-red-500">Erreur: Clé API OpenWeatherMap non configurée.</p>`;
                return;
            }

            const apiUrl = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,current&units=metric&lang=fr&appid=${OPENWEATHER_API_KEY}`;
            const weatherAlertsDiv = document.getElementById('weatherAlerts');
            const forecastLocationNameDiv = document.getElementById('forecastLocationName');
            const dailyForecastContentDiv = document.getElementById('dailyForecastContent');

            weatherAlertsDiv.innerHTML = '<p class="text-gray-500">Chargement des alertes...</p>';
            forecastLocationNameDiv.textContent = 'Chargement des prévisions...';
            dailyForecastContentDiv.innerHTML = '';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();

                // Afficher le nom de la ville (via une API de géocodage inverse, non incluse ici pour simplicité)
                // Pour l'instant, on affiche juste les coordonnées
                forecastLocationNameDiv.textContent = `Prévisions pour Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`;

                // Gérer les alertes météorologiques
                if (data.alerts && data.alerts.length > 0) {
                    weatherAlertsDiv.innerHTML = '<h3 class="text-xl font-semibold text-gray-800 mb-2">Alertes Actives:</h3>';
                    data.alerts.forEach(alert => {
                        const startTime = new Date(alert.start * 1000).toLocaleString();
                        const endTime = new Date(alert.end * 1000).toLocaleString();
                        weatherAlertsDiv.innerHTML += `
                            <div class="alert-item">
                                <strong>${alert.event}</strong> de ${alert.sender_name}<br>
                                Début: ${startTime}<br>
                                Fin: ${endTime}<br>
                                <p class="mt-1 text-gray-700">${alert.description}</p>
                            </div>
                        `;
                    });
                } else {
                    weatherAlertsDiv.innerHTML = '<p class="text-green-600">Aucune alerte météorologique active pour cette zone.</p>';
                }

                // Gérer les prévisions horaires pour le graphique de température
                const hourlyData = data.hourly.slice(0, 48); // Prévisions pour les 48 prochaines heures
                const labels = hourlyData.map(h => new Date(h.dt * 1000).getHours() + 'h');
                const temperatures = hourlyData.map(h => h.temp);

                if (tempChartInstance) {
                    tempChartInstance.destroy(); // Détruire l'ancienne instance du graphique
                }

                const ctxTemp = document.getElementById('tempChart').getContext('2d');
                tempChartInstance = new Chart(ctxTemp, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Température (°C)',
                            data: temperatures,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Température Horaire (°C) pour les 48 prochaines heures',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Température (°C)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#555'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Heure',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#555'
                                }
                            }
                        }
                    }
                });

                // Gérer les prévisions journalières pour le graphique de probabilité de précipitation
                const dailyData = data.daily.slice(0, 5); // 5 prochains jours
                const popLabels = dailyData.map(day => new Date(day.dt * 1000).toLocaleDateString('fr-FR', { weekday: 'short' }));
                const popData = dailyData.map(day => (day.pop * 100).toFixed(0)); // Convertir en pourcentage

                if (popChartInstance) {
                    popChartInstance.destroy(); // Détruire l'ancienne instance du graphique POP
                }

                const ctxPop = document.getElementById('popChart').getContext('2d');
                popChartInstance = new Chart(ctxPop, {
                    type: 'bar', // Graphique à barres pour la POP
                    data: {
                        labels: popLabels,
                        datasets: [{
                            label: 'Probabilité de Précipitation (%)',
                            data: popData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)', // Bleu
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Probabilité de Précipitation (%) pour les 5 prochains jours',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100, // Max 100%
                                title: {
                                    display: true,
                                    text: 'Probabilité (%)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#555'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Jour',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    color: '#555'
                                }
                            }
                        }
                    }
                });

                // Gérer les prévisions journalières (résumé textuel)
                dailyForecastContentDiv.innerHTML = '';
                dailyData.forEach(day => {
                    const date = new Date(day.dt * 1000).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                    const iconUrl = `https://openweathermap.org/img/wn/${day.weather[0].icon}@2x.png`;
                    dailyForecastContentDiv.innerHTML += `
                        <div class="daily-forecast-card flex flex-col items-center text-center">
                            <h4 class="font-bold text-gray-800 text-lg mb-2">${date}</h4>
                            <img src="${iconUrl}" alt="${day.weather[0].description}" class="w-20 h-20 mb-2">
                            <p class="text-gray-700 text-base mb-1">${day.weather[0].description}</p>
                            <p class="text-xl font-semibold text-blue-700">Min: ${day.temp.min.toFixed(1)}°C</p>
                            <p class="text-xl font-semibold text-red-700">Max: ${day.temp.max.toFixed(1)}°C</p>
                            <p class="text-gray-600 text-sm mt-1">Prob. Pluie: ${(day.pop * 100).toFixed(0)}%</p>
                        </div>
                    `;
                });


            } catch (error) {
                console.error('Erreur lors de la récupération des données météorologiques:', error);
                showStatusMessage(`Erreur lors du chargement des données météorologiques: ${error.message}`, true);
                weatherAlertsDiv.innerHTML = `<p class="text-red-500">Impossible de charger les données météorologiques. ${error.message}</p>`;
                forecastLocationNameDiv.textContent = '';
                dailyForecastContentDiv.innerHTML = '';
            } finally {
                toggleLoading(false);
            }
        }
    </script>
</body>
</html>
