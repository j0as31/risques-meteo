<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Séismes en Temps Réel</title>
    <!-- Inclure les fichiers CSS de Leaflet pour le style de la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Inclure les fichiers CSS de Leaflet.markercluster pour le style des clusters -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Inclure Tailwind CSS pour un style moderne et responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom style for the map */
        #map {
            height: calc(100vh - 180px); /* Adjusted to leave more space at the top */
            width: 100vw;
            border-radius: 1rem; /* More rounded corners */
            margin-top: 20px; /* More top margin */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Soft shadow */
        }
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #e2e8f0; /* Consistent background with the homepage */
            position: relative; /* For logo positioning */
        }
        /* Style for Leaflet popups */
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem; /* More rounded corners for popups */
            font-size: 0.95rem; /* Slightly larger font size */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content b {
            color: #333;
        }

        /* Styles for individual earthquake icons (to resemble previous circles) */
        .earthquake-icon {
            border-radius: 50%;
            border: 1px solid #000;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
        }
        .logo-container {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 30;
        }
        .logo-container img {
            border-radius: 0.75rem;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease-in-out;
        }
        .logo-container img:hover {
            transform: scale(1.1);
        }
        /* Styles for headings */
        h1 {
            color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Clickable logo to return to homepage -->
    <div class="logo-container">
        <a href="index.html">
            <svg class="w-16 h-16 text-blue-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6a1 1 0 10-2 0V6z" clip-rule="evenodd"></path>
            </svg>
            <span class="sr-only">Home</span>
        </a>
    </div>

    <!-- Main application container -->
    <div class="relative w-full h-full flex flex-col items-center justify-start py-4">
        <!-- Application title -->
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-8">
            Carte des Séismes en Temps Réel
        </h1>

        <!-- Navigation bar -->
        <nav class="flex flex-wrap justify-center gap-6 mb-10 p-4 bg-gradient-to-r from-blue-600 to-blue-800 rounded-full shadow-xl">
            <a href="index.html" class="px-7 py-3 text-white font-semibold rounded-full hover:bg-blue-700 transition ease-in-out duration-300 transform hover:scale-105">
                Accueil
            </a>
            <a href="earthquake_map.html" class="px-7 py-3 bg-blue-700 text-white font-bold rounded-full shadow-md hover:bg-blue-900 transition ease-in-out duration-300 transform hover:scale-105">
                Carte des Séismes
            </a>
            <a href="country_info.html" class="px-7 py-3 text-white font-semibold rounded-full hover:bg-blue-700 transition ease-in-out duration-300 transform hover:scale-105">
                Informations sur les Pays
            </a>
        </nav>

        <!-- Date controls -->
        <div class="z-10 bg-white p-6 rounded-lg shadow-lg flex flex-wrap justify-center items-center gap-6 mb-6">
            <label for="startDate" class="font-medium text-gray-700 text-lg">Date de début:</label>
            <input type="date" id="startDate" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">

            <label for="endDate" class="font-medium text-gray-700 text-lg">Date de fin:</label>
            <input type="date" id="endDate" class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">

            <button id="loadDataButton" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150 transform hover:scale-105">
                Charger les données
            </button>
        </div>

        <!-- Div that will contain the Leaflet map -->
        <div id="map" class="relative z-0"></div>

        <!-- Loading message -->
        <div id="loading-message" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-20 text-white text-xl font-semibold rounded-lg">
            Chargement des données sismiques...
        </div>
    </div>

    <!-- Include Leaflet JavaScript files (MUST be after the map div) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Include Leaflet.markercluster JavaScript files -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // Declaration of a variable for the map and one for the earthquake layer group
        let map;
        let markers; // Variable for the clustered marker group

        // Utility function to format a date to YYYY-MM-DD format
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Main function to fetch and display earthquakes
        async function fetchAndDisplayEarthquakes(startDate, endDate) {
            // Display loading message
            document.getElementById('loading-message').style.display = 'flex';

            // Construct the USGS API URL with specified dates
            // minmagnitude=2.5 to filter out small earthquakes
            const usgsApiUrl = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${startDate}&endtime=${endDate}&minmagnitude=2.5`;

            // If the marker group already exists, clear it before adding new data
            if (markers) {
                markers.clearLayers();
            } else {
                // Otherwise, create a new clustered marker group
                markers = L.markerClusterGroup();
                map.addLayer(markers); // Add the cluster group to the map
            }

            try {
                const response = await fetch(usgsApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                const data = await response.json();

                // Iterate over each earthquake and create a marker
                data.features.forEach(feature => {
                    const latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                    const magnitude = feature.properties.mag;
                    const place = feature.properties.place;
                    const time = new Date(feature.properties.time).toLocaleString();
                    const url = feature.properties.url;

                    let color;
                    let size; // Use 'size' for icon width/height

                    // Define the color and size of the icon based on magnitude
                    if (magnitude < 3.0) {
                        color = '#4CAF50'; // Green
                        size = 20; // Size in pixels
                    } else if (magnitude < 5.0) {
                        color = '#FFC107'; // Yellow/Orange
                        size = 30;
                    } else if (magnitude < 7.0) {
                        color = '#FF5722'; // Orange/Red
                        size = 40;
                    } else {
                        color = '#D32F2F'; // Dark red
                        size = 50;
                    }

                    // Create a custom HTML icon for the marker (to resemble a circle)
                    const earthquakeIcon = L.divIcon({
                        className: 'earthquake-icon',
                        html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px;"></div>`,
                        iconSize: [size, size],
                        iconAnchor: [size / 2, size / 2]
                    });

                    // Create a Leaflet marker with the custom icon
                    const marker = L.marker(latlng, { icon: earthquakeIcon });

                    // Add a popup that appears on click on the marker
                    marker.bindPopup(`
                        <div class="font-semibold text-gray-800">
                            <b>Magnitude:</b> <span class="text-lg text-blue-700">${magnitude}</span><br>
                            <b>Lieu:</b> ${place}<br>
                            <b>Heure:</b> ${time}<br>
                            <a href="${url}" target="_blank" class="text-blue-500 hover:underline">Plus d'infos</a>
                        </div>
                    `);

                    markers.addLayer(marker); // Add the marker to the cluster group
                });

            } catch (error) {
                console.error('Error fetching or processing seismic data:', error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.id = 'error-message';
                errorMessageDiv.className = 'absolute inset-0 bg-red-800 bg-opacity-75 flex items-center justify-center z-20 text-white text-xl font-semibold rounded-lg p-4 text-center';
                errorMessageDiv.innerHTML = `
                    <p>Désolé, une erreur est survenue lors du chargement des données sismiques.</p>
                    <p>Veuillez réessayer plus tard ou vérifier votre connexion internet.</p>
                    <p>Détails: ${error.message}</p>
                `;
                document.body.appendChild(errorMessageDiv);
            } finally {
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        // Wait for the window to be fully loaded before executing the script
        window.onload = function() {
            document.getElementById('loading-message').style.display = 'none';

            map = L.map('map').setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const loadButton = document.getElementById('loadDataButton');

            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);

            startDateInput.value = formatDate(sevenDaysAgo);
            endDateInput.value = formatDate(today);

            fetchAndDisplayEarthquakes(startDateInput.value, endDateInput.value);

            loadButton.addEventListener('click', () => {
                const start = startDateInput.value;
                const end = endDateInput.value;
                if (start && end) {
                    fetchAndDisplayEarthquakes(start, end);
                } else {
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white p-3 rounded-lg shadow-lg z-50';
                    errorMessageDiv.textContent = "Veuillez sélectionner une date de début et une date de fin.";
                    document.body.appendChild(errorMessageDiv);
                    setTimeout(() => {
                        errorMessageDiv.remove();
                    }, 3000);
                }
            });
        };
    </script>
</body>
</html>
