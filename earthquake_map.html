<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Séismes en Temps Réel</title>
    <!-- Inclure les fichiers CSS de Leaflet pour le style de la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Inclure les fichiers CSS de Leaflet.markercluster pour le style des clusters -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Inclure Tailwind CSS pour un style moderne et responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            overflow-x: hidden; /* Empêche le défilement horizontal */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: #f0f4f8; /* Arrière-plan cohérent avec la page d'accueil */
            position: relative; /* Pour le positionnement du logo */
        }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Dégradé de bleu-violet */
            color: white;
            padding: 4rem 20px 2rem; /* Rembourrage ajusté pour la page de la carte */
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* Ombre plus prononcée */
            position: relative;
            z-index: 1;
        }
        .hero-section h1 {
            color: white; /* Assure que le titre est blanc sur la section hero */
        }
        .nav-button {
            background: rgba(255, 255, 255, 0.15); /* Fond semi-transparent */
            backdrop-filter: blur(5px); /* Effet de flou */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Bordure légère */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.75rem;
            border-radius: 9999px; /* Entièrement arrondi */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .nav-button.active {
            background-color: #ffffff;
            color: #667eea; /* Couleur du dégradé pour le texte actif */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        .logo-container {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 30;
        }
        .logo-container svg {
            border-radius: 0.75rem;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease-in-out;
            background-color: #ffffff;
            padding: 5px;
        }
        .logo-container svg:hover {
            transform: scale(1.1);
        }
        
        /* Style pour le conteneur de contenu principal */
        .main-content-container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 3.5rem;
            width: 100%;
            max-width: 1300px;
            margin-top: -80px; /* Chevauchement avec la section hero */
            position: relative;
            z-index: 2;
            margin-bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Style pour la carte des contrôles de date (correspondant à la section-card de la page d'accueil) */
        .section-card {
            background-color: #fdfefe; /* Presque blanc pour les cartes */
            border-radius: 1.25rem; /* Coins encore plus arrondis */
            padding: 2.5rem;
            margin-top: 2.5rem; /* Ajusté pour le placement sous la section hero */
            border: 1px solid #e0e7ee; /* Bordure très légère */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08); /* Ombre plus nette */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            width: 100%; /* S'assure qu'il prend toute la largeur de son parent */
            max-width: 900px; /* Limite la largeur pour l'esthétique */
            display: flex; /* Utilise flex pour la mise en page interne */
            flex-wrap: wrap; /* Permet aux éléments de s'envelopper sur les petits écrans */
            justify-content: center; /* Centre les éléments */
            align-items: center; /* Centre les éléments verticalement */
            gap: 1.5rem; /* Espace entre les éléments */
        }
        .section-card:hover {
            transform: translateY(-10px); /* Mouvement plus prononcé au survol */
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.15); /* Ombre plus forte au survol */
        }

        /* Style pour la carte */
        #map {
            height: 600px; /* Hauteur fixe pour la carte */
            width: 100%; /* Prend toute la largeur de son conteneur */
            border-radius: 1.5rem; /* Correspond au rayon de la bordure du conteneur */
            margin-top: 2.5rem; /* Espace sous les contrôles de date */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Ombre douce */
            z-index: 0; /* S'assure que la carte est derrière les superpositions */
        }

        /* Styles pour les icônes de séisme individuelles (pour ressembler aux cercles précédents) */
        .earthquake-icon {
            /* Le div extérieur pour l'icône Leaflet. Il agit comme un conteneur. */
            opacity: 0.8;
            display: flex; /* Utilise flex pour centrer le cercle intérieur */
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out; /* Transition douce pour le survol */
        }
        .earthquake-icon:hover {
            transform: scale(1.1); /* Agrandit légèrement au survol */
            opacity: 1;
        }
        .earthquake-icon > div { /* Cible le div intérieur qui est le cercle coloré réel */
            border-radius: 50%; /* Le rend circulaire */
            border: 1px solid #000; /* Bordure pour la visibilité */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Ajoute une ombre subtile */
            display: flex; /* Pour centrer le texte de magnitude à l'intérieur */
            align-items: center;
            justify-content: center;
            color: white; /* Couleur du texte pour la magnitude */
            font-weight: bold;
        }
        /* Style du message de chargement */
        #loading-message {
            position: fixed; /* Utilise fixed pour la superposition plein écran */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9); /* Superposition plus foncée */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50; /* Z-index élevé pour être au-dessus */
            color: white;
            font-size: 2.5rem; /* Police plus grande */
            font-weight: bold;
            border-radius: 1rem; /* Coins arrondis pour la superposition */
            transition: opacity 0.3s ease-in-out; /* Fondu doux */
        }
        #loading-message.hidden {
            opacity: 0;
            pointer-events: none; /* Permet les clics à travers lorsqu'il est caché */
        }

        /* Style du message d'erreur */
        #status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #dc2626; /* Arrière-plan rouge */
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 40;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            display: none; /* Caché par défaut */
        }
        #status-message p {
            margin-bottom: 0.5rem;
        }
        #status-message p:last-child {
            margin-bottom: 0;
        }

        /* Boutons de navigation pour les contrôles de date */
        .date-nav-button {
            padding: 0.75rem 1.25rem;
            background-color: #667eea; /* Bleu de la section hero */
            color: white;
            font-weight: bold;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .date-nav-button:hover {
            background-color: #5a67d8; /* Bleu plus foncé au survol */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .date-nav-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .date-nav-button.today-button {
            background-color: #38a169; /* Vert pour le bouton aujourd'hui */
        }
        .date-nav-button.today-button:hover {
            background-color: #2f855a;
        }
        .date-nav-button.period-button { /* Style pour les nouveaux boutons de période */
            background-color: #3b82f6; /* Bleu légèrement différent */
        }
        .date-nav-button.period-button:hover {
            background-color: #2563eb;
        }


        /* Style du bouton de chargement des données (correspondant au bouton vert de la page d'accueil) */
        .load-data-button {
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); /* Dégradé vert */
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            border-radius: 9999px; /* Entièrement arrondi */
            box-shadow: 0 6px 12px rgba(34, 197, 94, 0.3); /* Ombre verte */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .load-data-button:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(34, 197, 94, 0.4);
        }
        .load-data-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2);
        }

        /* Ajustements pour l'alignement des éléments dans la section-card */
        .date-controls-group {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap; /* Permet aux éléments de s'envelopper sur les petits écrans */
            justify-content: center;
            width: 100%; /* Prend toute la largeur disponible dans la section-card */
        }
        .period-buttons-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 1rem; /* Espace au-dessus des boutons de période */
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Logo cliquable pour revenir à l'accueil -->
    <div class="logo-container">
        <a href="index.html">
            <svg class="w-16 h-16 text-blue-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6a1 1 0 10-2 0V6z" clip-rule="evenodd"></path>
            </svg>
            <span class="sr-only">Accueil</span>
        </a>
    </div>

    <!-- Hero Section -->
    <div class="hero-section">
        <h1 class="text-5xl md:text-6xl font-extrabold mb-4 animate-fade-in-up">
            Carte des Séismes en Temps Réel
        </h1>
        <p class="text-xl md:text-2xl font-light mb-8 animate-fade-in-up delay-100">
            Explorez l'activité sismique mondiale avec des données actualisées.
        </p>
        <!-- Barre de navigation intégrée à la hero section -->
        <nav class="flex flex-wrap justify-center gap-4 animate-fade-in-up delay-200">
            <a href="index.html" class="nav-button">
                Accueil
            </a>
            <a href="earthquake_map.html" class="nav-button active">
                Carte des Séismes
            </a>
            <a href="country_info.html" class="nav-button">
                Informations sur les Pays
            </a>
        </nav>
    </div>

    <!-- Main content container -->
    <div class="main-content-container">
        <!-- Date controls -->
        <div class="section-card">
            <div class="date-controls-group">
                <button id="prevDayButton" class="date-nav-button">
                    &larr; Jour précédent
                </button>
                <div id="currentDateRangeDisplay" class="text-gray-800 font-semibold text-xl text-center flex-grow">
                    Chargement de la période...
                </div>
                <button id="nextDayButton" class="date-nav-button">
                    Jour suivant &rarr;
                </button>
                <button id="todayButton" class="date-nav-button today-button">
                    Aujourd'hui
                </button>
            </div>
            <div class="period-buttons-group">
                <button id="thisMonthButton" class="date-nav-button period-button">
                    Ce mois-ci
                </button>
                <button id="thisYearButton" class="date-nav-button period-button">
                    Cette année
                </button>
            </div>
            <button id="loadDataButton" class="load-data-button mt-4 sm:mt-0">
                Charger les données
            </button>
        </div>

        <!-- Div that will contain the Leaflet map -->
        <div id="map"></div>

        <!-- Loading message -->
        <div id="loading-message" class="hidden">
            Chargement des données sismiques...
        </div>

        <!-- Error/Information message -->
        <div id="status-message" class="fixed bottom-6 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl z-50 text-xl font-semibold hidden">
            <!-- Les messages d'erreur ou d'information seront affichés ici -->
        </div>
    </div>

    <!-- Include Leaflet JavaScript files (MUST be after the map div) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Include Leaflet.markercluster JavaScript files -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // Déclaration des variables pour la carte et le groupe de calques de séismes
        let map;
        let markers; // Variable pour le groupe de marqueurs clusterisés
        let currentEndDate; // Représente la date de fin de la fenêtre de 7 jours (ou autre période)

        // Fonction utilitaire pour formater une date au format YYYY-MM-DD pour les appels API
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Fonction utilitaire pour formater une date pour l'affichage (ex: "13 juil. 2025")
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Fonction pour afficher les messages d'état (correspondant au style de la page d'accueil)
        function showStatusMessage(message, isError = false) {
            const statusMessageDiv = document.getElementById('status-message');
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `fixed bottom-6 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-xl z-50 text-xl font-semibold ${isError ? 'bg-red-600' : 'bg-blue-600'} text-white`;
            statusMessageDiv.classList.remove('hidden');
            setTimeout(() => {
                statusMessageDiv.classList.add('hidden');
            }, 5000);
        }

        // Fonction pour basculer la visibilité du message de chargement (correspondant au style de la page d'accueil)
        function toggleLoading(show) {
            document.getElementById('loading-message').classList.toggle('hidden', !show);
        }

        // Fonction pour mettre à jour l'affichage de la plage de dates
        function updateDateRangeDisplay(startDate, endDate) {
            document.getElementById('currentDateRangeDisplay').textContent = 
                `Du ${formatDateForDisplay(startDate)} au ${formatDateForDisplay(endDate)}`;
        }

        // Fonction principale pour récupérer et afficher les séismes
        async function fetchAndDisplayEarthquakes(startOverride = null, endOverride = null) {
            toggleLoading(true); // Affiche le message de chargement

            let startDate;
            let endDate;

            if (startOverride && endOverride) {
                startDate = startOverride;
                endDate = endOverride;
            } else {
                // Par défaut, utilise la fenêtre de 7 jours se terminant à currentEndDate
                endDate = new Date(currentEndDate); // Crée une copie pour éviter de modifier currentEndDate directement
                startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - 7); // Calcule la date de début pour la fenêtre de 7 jours
            }

            // Met à jour l'affichage de la plage de dates
            updateDateRangeDisplay(startDate, endDate);

            const usgsApiUrl = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${formatDateForAPI(startDate)}&endtime=${formatDateForAPI(endDate)}&minmagnitude=2.5`;

            // --- LOGS DE DÉBOGAGE ---
            console.log("Fetching earthquakes for:");
            console.log("  Start Date (API Format):", formatDateForAPI(startDate));
            console.log("  End Date (API Format):", formatDateForAPI(endDate));
            console.log("  API URL:", usgsApiUrl);
            // --- FIN DES LOGS DE DÉBOGAGE ---

            // Si le groupe de marqueurs existe déjà, le vide avant d'ajouter de nouvelles données
            if (markers) {
                markers.clearLayers();
            } else {
                // Sinon, crée un nouveau groupe de marqueurs clusterisés
                markers = L.markerClusterGroup();
                map.addLayer(markers); // Ajoute le groupe de clusters à la carte
            }

            try {
                const response = await fetch(usgsApiUrl);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                }
                const data = await response.json();

                if (data.features.length === 0) {
                    showStatusMessage("Aucun séisme trouvé pour cette période.", false);
                } else {
                    // Itère sur chaque séisme et crée un marqueur
                    data.features.forEach(feature => {
                        const latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                        const magnitude = feature.properties.mag;
                        const place = feature.properties.place;
                        const time = new Date(feature.properties.time).toLocaleString('fr-FR'); // Formate l'heure pour la locale française
                        const url = feature.properties.url;

                        let color;
                        let size; // Utilise 'size' pour la largeur/hauteur de l'icône

                        // Définit la couleur et la taille de l'icône en fonction de la magnitude
                        if (magnitude < 3.0) {
                            color = '#4CAF50'; // Vert
                            size = 25; // Taille en pixels
                        } else if (magnitude < 5.0) {
                            color = '#FFC107'; // Jaune/Orange
                            size = 35;
                        } else if (magnitude < 7.0) {
                            color = '#FF5722'; // Orange/Rouge
                            size = 45;
                        } else {
                            color = '#D32F2F'; // Rouge foncé
                            size = 55;
                        }

                        // Crée une icône HTML personnalisée pour le marqueur (pour ressembler à un cercle)
                        const earthquakeIcon = L.divIcon({
                            className: 'earthquake-icon',
                            // Le div intérieur est le cercle coloré réel avec le texte de magnitude
                            html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; font-size: ${size * 0.4}px;">${magnitude.toFixed(1)}</div>`,
                            iconSize: [size, size],
                            iconAnchor: [size / 2, size / 2]
                        });

                        // Crée un marqueur Leaflet avec l'icône personnalisée
                        const marker = L.marker(latlng, { icon: earthquakeIcon });

                        // Ajoute une popup qui apparaît au clic sur le marqueur
                        marker.bindPopup(`
                            <div class="font-semibold text-gray-800">
                                <b>Magnitude:</b> <span class="text-lg text-blue-700">${magnitude}</span><br>
                                <b>Lieu:</b> ${place}<br>
                                <b>Heure:</b> ${time}<br>
                                <a href="${url}" target="_blank" class="text-blue-500 hover:underline">Plus d'infos</a>
                            </div>
                        `);

                        markers.addLayer(marker); // Ajoute le marqueur au groupe de clusters
                    });
                    showStatusMessage(`Chargement de ${data.features.length} séismes réussi.`, false);
                }

            } catch (error) {
                console.error('Erreur lors de la récupération ou du traitement des données sismiques:', error);
                showStatusMessage(`Désolé, une erreur est survenue lors du chargement des données sismiques. Détails: ${error.message}`, true);
            } finally {
                toggleLoading(false); // Masque le message de chargement
            }
        }

        // Écouteurs d'événements pour les boutons de navigation de date
        document.addEventListener('DOMContentLoaded', () => {
            // Initialise la carte centrée à [0, 0] avec un niveau de zoom de 2
            map = L.map('map').setView([0, 0], 2);

            // Ajoute les tuiles OpenStreetMap à la carte
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Définit la plage de dates initiale sur les 7 derniers jours se terminant aujourd'hui
            currentEndDate = new Date();
            // Appelle fetchAndDisplayEarthquakes sans overrides pour charger la période par défaut (7 jours)
            fetchAndDisplayEarthquakes(); 

            document.getElementById('prevDayButton').addEventListener('click', () => {
                currentEndDate.setDate(currentEndDate.getDate() - 1); // Déplace la date de fin d'un jour en arrière
                fetchAndDisplayEarthquakes(); // Recharge les données pour la nouvelle plage
            });

            document.getElementById('nextDayButton').addEventListener('click', () => {
                currentEndDate.setDate(currentEndDate.getDate() + 1); // Déplace la date de fin d'un jour en avant
                fetchAndDisplayEarthquakes(); // Recharge les données pour la nouvelle plage
            });

            document.getElementById('todayButton').addEventListener('click', () => {
                currentEndDate = new Date(); // Réinitialise la date de fin à aujourd'hui
                fetchAndDisplayEarthquakes(); // Recharge les données pour la plage d'aujourd'hui
            });

            document.getElementById('thisMonthButton').addEventListener('click', () => {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                fetchAndDisplayEarthquakes(firstDayOfMonth, today);
            });

            document.getElementById('thisYearButton').addEventListener('click', () => {
                const today = new Date();
                const firstDayOfYear = new Date(today.getFullYear(), 0, 1); // Mois est 0-indexé
                fetchAndDisplayEarthquakes(firstDayOfYear, today);
            });

            document.getElementById('loadDataButton').addEventListener('click', () => {
                // Ce bouton recharge maintenant simplement les données pour la plage actuellement affichée
                fetchAndDisplayEarthquakes();
            });
        });
    </script>
</body>
</html>
