<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Séismes en Temps Réel</title>
    <!-- Inclure les fichiers CSS de Leaflet pour le style de la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Inclure les fichiers CSS de Leaflet.markercluster pour le style des clusters -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Inclure Tailwind CSS pour un style moderne et responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Style personnalisé pour la carte */
        #map {
            height: calc(100vh - 120px); /* La carte prendra presque toute la hauteur, laissant de la place pour les contrôles */
            width: 100vw; /* La carte prendra toute la largeur de la fenêtre */
            border-radius: 0.5rem; /* Coins arrondis pour la carte */
            margin-top: 10px; /* Petite marge en haut pour séparer des contrôles */
        }
        /* Assurez-vous que le corps de la page n'a pas de marges par défaut */
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif; /* Utilisation de la police Inter */
            overflow: hidden; /* Empêche le défilement si la carte est plus grande que la fenêtre */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Aligner le contenu en haut */
            min-height: 100vh; /* Assure que le corps prend au moins toute la hauteur de la vue */
            background-color: #f3f4f6; /* Couleur de fond légère */
        }
        /* Style pour les popups Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem; /* Coins arrondis pour les popups */
            font-size: 0.875rem; /* Taille de police légèrement plus petite */
        }
        .leaflet-popup-content b {
            color: #333; /* Couleur plus foncée pour le texte en gras */
        }

        /* Styles pour les icônes de séismes individuels (pour qu'ils ressemblent aux cercles précédents) */
        .earthquake-icon {
            border-radius: 50%; /* Rendre l'icône ronde */
            border: 1px solid #000; /* Bordure noire */
            opacity: 0.7; /* Opacité du remplissage */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem; /* Taille de la police pour la magnitude si affichée */
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Conteneur principal de l'application -->
    <div class="relative w-full h-full flex flex-col items-center justify-start py-4">
        <!-- Titre de l'application -->
        <h1 class="z-10 bg-white p-3 rounded-lg shadow-lg text-2xl font-bold text-gray-800 mb-4">
            Séismes en Temps Réel
        </h1>

        <!-- Contrôles de date -->
        <div class="z-10 bg-white p-4 rounded-lg shadow-lg flex flex-wrap justify-center items-center gap-4 mb-4">
            <label for="startDate" class="font-medium text-gray-700">Date de début:</label>
            <input type="date" id="startDate" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

            <label for="endDate" class="font-medium text-gray-700">Date de fin:</label>
            <input type="date" id="endDate" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

            <button id="loadDataButton" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition ease-in-out duration-150">
                Charger les données
            </button>
            <!-- Nouveau bouton de navigation vers la page d'informations sur les pays -->
            <a href="country_info.html" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition ease-in-out duration-150">
                Informations sur les pays
            </a>
        </div>

        <!-- Div qui contiendra la carte Leaflet -->
        <div id="map" class="relative z-0"></div>

        <!-- Message de chargement -->
        <div id="loading-message" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-20 text-white text-xl font-semibold rounded-lg">
            Chargement des données sismiques...
        </div>
    </div>

    <!-- Inclure les fichiers JavaScript de Leaflet (DOIT être après la div de la carte) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Inclure les fichiers JavaScript de Leaflet.markercluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // Déclaration d'une variable pour la carte et une pour le groupe de couches des séismes
        let map;
        let markers; // Variable pour le groupe de marqueurs clusterisés

        // Fonction utilitaire pour formater une date au format YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mois est basé sur 0
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Fonction principale pour récupérer et afficher les séismes
        async function fetchAndDisplayEarthquakes(startDate, endDate) {
            // Afficher le message de chargement
            document.getElementById('loading-message').style.display = 'flex';

            // Construire l'URL de l'API USGS avec les dates spécifiées
            // minmagnitude=2.5 pour filtrer les séismes de petite taille
            const usgsApiUrl = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${startDate}&endtime=${endDate}&minmagnitude=2.5`;

            // Si le groupe de marqueurs existe déjà, le vider avant d'ajouter de nouvelles données
            if (markers) {
                markers.clearLayers();
            } else {
                // Sinon, créer un nouveau groupe de marqueurs clusterisés
                markers = L.markerClusterGroup();
                map.addLayer(markers); // Ajouter le groupe de clusters à la carte
            }

            try {
                const response = await fetch(usgsApiUrl);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const data = await response.json();

                // Itérer sur chaque séisme et créer un marqueur
                data.features.forEach(feature => {
                    const latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                    const magnitude = feature.properties.mag;
                    const place = feature.properties.place;
                    const time = new Date(feature.properties.time).toLocaleString();
                    const url = feature.properties.url;

                    let color;
                    let size; // Utiliser 'size' pour la largeur/hauteur de l'icône

                    // Définir la couleur et la taille de l'icône en fonction de la magnitude
                    if (magnitude < 3.0) {
                        color = '#4CAF50'; // Vert
                        size = 20; // Taille en pixels
                    } else if (magnitude < 5.0) {
                        color = '#FFC107'; // Jaune/Orange
                        size = 30;
                    } else if (magnitude < 7.0) {
                        color = '#FF5722'; // Orange/Rouge
                        size = 40;
                    } else {
                        color = '#D32F2F'; // Rouge foncé
                        size = 50;
                    }

                    // Créer une icône HTML personnalisée pour le marqueur (pour qu'il ressemble à un cercle)
                    const earthquakeIcon = L.divIcon({
                        className: 'earthquake-icon',
                        html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px;"></div>`,
                        iconSize: [size, size], // Taille de l'icône
                        iconAnchor: [size / 2, size / 2] // Point d'ancrage de l'icône (centre)
                    });

                    // Créer un marqueur Leaflet avec l'icône personnalisée
                    const marker = L.marker(latlng, { icon: earthquakeIcon });

                    // Ajouter une info-bulle (popup) qui s'affiche au clic sur le marqueur
                    marker.bindPopup(`
                        <div class="font-semibold text-gray-800">
                            <b>Magnitude:</b> <span class="text-lg text-blue-700">${magnitude}</span><br>
                            <b>Lieu:</b> ${place}<br>
                            <b>Heure:</b> ${time}<br>
                            <a href="${url}" target="_blank" class="text-blue-500 hover:underline">Plus d'infos</a>
                        </div>
                    `);

                    markers.addLayer(marker); // Ajouter le marqueur au groupe de clusters
                });

            } catch (error) {
                console.error('Erreur lors de la récupération ou du traitement des données sismiques:', error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.id = 'error-message';
                errorMessageDiv.className = 'absolute inset-0 bg-red-800 bg-opacity-75 flex items-center justify-center z-20 text-white text-xl font-semibold rounded-lg p-4 text-center';
                errorMessageDiv.innerHTML = `
                    <p>Désolé, une erreur est survenue lors du chargement des données sismiques.</p>
                    <p>Veuillez réessayer plus tard ou vérifier votre connexion internet.</p>
                    <p>Détails: ${error.message}</p>
                `;
                document.body.appendChild(errorMessageDiv);
            } finally {
                // Masquer le message de chargement une fois les données chargées ou en cas d'erreur
                document.getElementById('loading-message').style.display = 'none';
            }
        }

        // Attendre que la fenêtre soit complètement chargée avant d'exécuter le script
        window.onload = function() {
            // Masquer le message de chargement initial
            document.getElementById('loading-message').style.display = 'none';

            // Initialiser la carte Leaflet une seule fois
            map = L.map('map').setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Récupérer les éléments HTML des dates et du bouton
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const loadButton = document.getElementById('loadDataButton');

            // Définir les dates par défaut (par exemple, les 7 derniers jours)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);

            startDateInput.value = formatDate(sevenDaysAgo);
            endDateInput.value = formatDate(today);

            // Charger les données initiales au chargement de la page
            fetchAndDisplayEarthquakes(startDateInput.value, endDateInput.value);

            // Ajouter un écouteur d'événement au bouton pour recharger les données
            loadButton.addEventListener('click', () => {
                const start = startDateInput.value;
                const end = endDateInput.value;
                if (start && end) {
                    fetchAndDisplayEarthquakes(start, end);
                } else {
                    // Utilisation d'un message d'erreur personnalisé au lieu d'alert()
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white p-3 rounded-lg shadow-lg z-50';
                    errorMessageDiv.textContent = "Veuillez sélectionner une date de début et une date de fin.";
                    document.body.appendChild(errorMessageDiv);
                    setTimeout(() => {
                        errorMessageDiv.remove();
                    }, 3000); // Supprime le message après 3 secondes
                }
            });
        };
    </script>
</body>
</html>
